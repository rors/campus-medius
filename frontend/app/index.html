<!DOCTYPE html>
<html ng-app="CampusMediusApp">
<head>
    <title></title>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>

    <script src="//s0.2mdn.net/instream/html5/ima3.js" type="text/javascript"></script>
    <script src="bower_components/jquery/jquery.js"></script>
    <script src="bower_components/angular/angular.js"></script>

    <script src="js/angular-leaflet-directive.min.js"></script>
    <script src="js/rzslider.min.js"></script>
    <script src="js/underscore-min.js"></script>

    <script src="bower_components/angular-route/angular-route.js"></script>
    <script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
    <!-- build:js({.tmp,app}) scripts/scripts.js -->
    <script src="scripts/com/2fdevs/videogular/videogular.js"></script>
    <script src="scripts/com/2fdevs/videogular/plugins/controls.js"></script>
    <script src="scripts/com/2fdevs/videogular/plugins/overlay-play.js"></script>
    <script src="scripts/com/2fdevs/videogular/plugins/buffering.js"></script>
    <script src="scripts/com/2fdevs/videogular/plugins/poster.js"></script>
    <script src="scripts/com/2fdevs/videogular/plugins/ima-ads.js"></script>
    <!-- endbuild -->

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/rzslider.css" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <script>
        var app = angular.module("CampusMediusApp", ['leaflet-directive', 'ngRoute', 'rzModule', "com.2fdevs.videogular",
            "com.2fdevs.videogular.plugins.controls",
            "com.2fdevs.videogular.plugins.overlayplay",
            "com.2fdevs.videogular.plugins.buffering",
            "com.2fdevs.videogular.plugins.poster",
            "com.2fdevs.videogular.plugins.imaads"]);

        app.factory('ActorService', function($http, $window){
            var API_ENDPOINT = $window.location.host==='localhost' ? 'http://localhost:3000/actors' : 'data/actors.json';
            var actors = [];
            return {
                all: function() {
                    return $http({method: 'GET', url: API_ENDPOINT})
                        .success(function(data, status, headers, config) { 
                            actors = data;
                         });
                },
                get: function(id) {
                    for(var i=0; i<actors.length; i++) {
                        if(actors[i].id == id) {
                            return actors[i];
                            break;
                        }
                    }
                    return false;
                },
                search: function(params) {
                    return _markers = actors.filter(function(el) {
                        isMatch = true;
                        if(params.hasOwnProperty('historical')) {
                            if(el.historical !== params.historical) {
                                return false;
                            }
                        }
                        // given 2 time ranges S1-->E1 and S2-->E2
                        // determine if 2 ranges overlap. S1 <= E2 && S2 <= E1
                        if(el.start <= params.end && params.start <= el.end) {
                            return el;
                        }
                    });
                }
            }
        });

        app.directive('scrollSpy', function($window) {
          return {
            restrict: 'A',
            controller: function($scope) {
              $scope.spies = [];
              $scope.test = 0;
              setTimeout(function(){console.log('$scope.test changed');$scope.test = 8}, 1000)
              this.addSpy = function(spyObj) {
                $scope.spies.push(spyObj);
              };
            },
            link: function(scope, elem, attrs) {
              var spyElems = [];
              scope.$watch('spies', function(spies) {
                for (var _i = 0; _i < spies.length; _i++) {
                  var spy = spies[_i];
                  if (spyElems[spy.id] == null) {
                    spyElems[spy.id] = (elem.find('#' + spy.id));
                  }
                }
                scrollHandler();
              }, true);

              var $spyWindow = $('#spy-window .text-window');
              //var $spyWindow = $window;
              function scrollHandler() {
                var highlightSpy, pos, spy, _i, _len, _ref;
                highlightSpy = null;
                _ref = scope.spies;
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  spy = _ref[_i];
                  spy.out();
                  spyElems[spy.id] = spyElems[spy.id].length === 0 ? elem.find('#' + spy.id) : spyElems[spy.id];
                  if (spyElems[spy.id].length !== 0) {
                    //console.log(spy.id, spyElems[spy.id].position().top , $spyWindow.scrollTop());
                    if ((pos = spyElems[spy.id].position().top) <= 0) {
                      spy.pos = pos;
                      if (highlightSpy == null) {
                        highlightSpy = spy;
                      }
                      if (highlightSpy.pos < spy.pos) {
                        highlightSpy = spy;
                      }
                    }
                  }
                }
                return highlightSpy != null ? highlightSpy["in"]() : void 0;
              };

              $($spyWindow).scroll(scrollHandler);
            }
          };
        })
        .directive('spy', function($location) {
          return {
            restrict: "A",
            require: "^scrollSpy",
            link: function(scope, elem, attrs, scrollSpy) {
              if (attrs.spyClass == null) {
                attrs.spyClass = "active";
              }
              elem.click(function() {
                scope.$apply(function() {
                  $location.hash(attrs.spy);
                });
              });
              scrollSpy.addSpy({
                id: attrs.spy,
                in: function() {
                  elem.addClass(attrs.spyClass);
                  $(window).trigger('resize');
                },
                out: function() {
                  elem.removeClass(attrs.spyClass);
                }
              });
            }
          };
        })

        // The app essentially has a single route, but we are handling the actorId param
        // as optional so we dont have to deal w reloading the page or losing our map view
        // when we go to actor view.
        app.config(function ($routeProvider) {
          $routeProvider
            .when('/actors/:actorId?', {
                templateUrl: 'views/map.html',
                reloadOnSearch: false,
                controller: 'MapController'
            })
            .otherwise({
              redirectTo: '/actors'
            });
        });

        app.controller("MapController", [ '$scope', '$sce', '$http', '$compile', '$location', '$routeParams', 'ActorService', function($scope, $sce, $http, $compile, $location, $routeParams, ActorService) {

            $scope.actors = new Array();    // holds all our actors so we dont have to fetch them from API again
            $scope.actor = false;           // either false or an actor object; if actor object, then show actor template
            $scope.markers = new Array();   // current set of points that are shown on our map.

            // TODO: hard-coded to Vienna but should probably come from some dynamic source
            $scope.centerMarker = {
                lat: 48.20817,
                lng: 16.37382,
                zoom: 8
            }
            // TODO: also hard coded; should come from service
            $scope.historical = ['All', 'Sovereign', 'Disciplinary', 'Control'];

            // TODO: all of this timeline stuff should really be broken out into its own directive
            $scope.lanes = new Array(); // holds lane data for showing timeline items
            $scope.timelineSlider = {
                min: 0,
                max: 24,
                floor: 0,
                ceil: 24,
                step: 1
            };
            $scope.translateTimeline = function(hours) {
                //it is pm if hours from 12 onwards
                suffix = (hours >= 12)? 'pm' : 'am';

                //only -12 from hours if it is greater than 12 (if not back at mid night)
                hours = (hours > 12) ? hours -12 : hours;

                //if 00 then it is 12 am
                hours = (hours == '00')? 12 : hours;

                return hours + suffix;
            };

            $scope.$watch('timelineSlider.min', function(oldVal, newVal) {
                if(oldVal != newVal) {
                    $scope.filterActors();
                }
            });

            $scope.$watch('timelineSlider.max', function(oldVal, newVal) {
                if(oldVal != newVal) {
                    $scope.filterActors();
                }
            });

            // returns an array of arrays
            // each lane contains objects in consecutive time chunks
            $scope.makeLanes = function(data) {
                var _lanes = [];
                for(var i=0; i<data.length; i++) {
                    var _actor = data[i];
                    if(i === 0) {
                        _lanes.push([_actor]);
                    } else {
                        var laneLength = _lanes.length;
                        var inLane = false;
                         for(var j=0; j<laneLength; j++){
                             if(_actor.start >= _lanes[j][_lanes[j].length-1].end) {
                                _lanes[j].push(_actor);
                                inLane = true;
                                break;
                            }
                         }
                         // item didnt fit in any of the existing lanes so make a new one
                         if(!inLane) {
                            _lanes.push([_actor]);
                         }
                    }
                }
                $scope.lanes = _lanes;
            };

            $scope.filterActors = function() {
                var params = {};
                if($scope.historicalFilter && $scope.historicalFilter !== 'All') {
                    params.historical = $scope.historicalFilter;
                }
                params.start = $scope.timelineSlider.min;
                params.end = $scope.timelineSlider.max;

                var _markers = ActorService.search(params);
                
                // updates our map markers
                angular.extend($scope, {
                    markers: _markers
                });

                // apply the search params only if we're not in actor view. 
                // angular is kind enough to preserve our search params when we use the 
                // actorId part of the route
                if(!$scope.actor) {
                    $location.search(params);
                }
            };

            // listens for changes in url, and fires the update
            $scope.$on('$routeUpdate', function(data){
                $scope.applyRouteParams();
            });

            // this makes sure the UI controls are in sync w the filters in URL
            $scope.applyRouteParams = function() {
                if($routeParams.hasOwnProperty('historical') && $routeParams.historical !== 'undefined') {
                    $scope.historicalFilter = $routeParams.historical;
                } else {
                    $scope.historicalFilter = undefined;
                }
                if($routeParams.hasOwnProperty('start')) {
                    $scope.timelineSlider.min = $routeParams.start;
                }
                if($routeParams.hasOwnProperty('end')) {
                    $scope.timelineSlider.max = $routeParams.end;
                }
                if($routeParams.hasOwnProperty('actorId')) {
                    $scope.actor = ActorService.get($routeParams.actorId);
                } else {
                    $scope.actor = false;
                }

                $scope.filterActors();
            };


            $scope.showActor = function(id) {
                $location.path('/actors/' + id);
            };
            $scope.highlightActor = function(id, toDefault){
                var icons = {
                    defaultIcon: {},
                    biggerIcon: {
                        iconSize: [30, 49]
                    }
                };

                for(var i=0; i<$scope.markers.length; i++) {
                    if($scope.markers[i].id === id) {
                        $scope.markers[i].icon = toDefault? icons.defaultIcon : icons.biggerIcon;
                        break;
                    }
                }
            }
            // i still dont understand how calling $location.path will magically preserve the 
            // search params in the url, but i love it
            $scope.killActor = function() {
                $scope.actor = false;
                $location.path('/actors');
            };

            // low-fi way of getting actors from our API
            $scope.getActors = function() {
                var actors = ActorService.all()
                .success(function(data, status, headers, config) {
                    // add bubble text
                    angular.forEach(data, function(val, key) {
                        val.message = '<p>' + val.title + "-" + val.body + " <a ng-click='showActor(" + val.id + ")'>click for more</a></p>";
                    });

                    $scope.actors = data;
                    $scope.makeLanes($scope.actors);
                    $scope.applyRouteParams();
                }).
                error(function(data, status, headers, config) {
                    console.log('error', data, status, headers, config);
                });
            }

            // since we are using directives inside our popups, we have to compile them
            // before they can be used
            $scope.$on('leafletDirectiveMap.popupopen', function(event, leafletEvent){
              var newScope = $scope.$new();
              $compile(leafletEvent.leafletEvent.popup._contentNode)(newScope);
            });

            // only gets called once. all subsequent filtering is handled in-app
            $scope.getActors();


            /* please work */
            $scope.currentTime = 0;
            $scope.totalTime = 0;
            $scope.state = null;
            $scope.volume = 1;
            $scope.isCompleted = false;
            $scope.API = null;

            $scope.onPlayerReady = function(API) {
                $scope.API = API;
            };

            $scope.onCompleteVideo = function() {
                $scope.isCompleted = true;
            };

            $scope.onUpdateState = function(state) {
                $scope.state = state;
            };

            $scope.onUpdateTime = function(currentTime, totalTime) {
                $scope.currentTime = currentTime;
                $scope.totalTime = totalTime;
            };

            $scope.onUpdateVolume = function(newVol) {
                $scope.volume = newVol;
            };

            $scope.onUpdateSize = function(width, height) {
                $scope.config.width = width;
                $scope.config.height = height;
            };

            $scope.stretchModes = [
                {label: "None", value: "none"},
                {label: "Fit", value: "fit"},
                {label: "Fill", value: "fill"}
            ];

            $scope.config = {
                width: 740,
                height: 380,
                autoHide: false,
                autoHideTime: 3000,
                autoPlay: false,
                responsive: false,
                stretch: $scope.stretchModes[1],
                sources: [
                    {src: $sce.trustAsResourceUrl("https://campusmedius.s3.amazonaws.com/assets/fox-newsreel_schoenbrunn-rally.mp4.mp4"), type: "video/mp4"},
                    {src: $sce.trustAsResourceUrl("http://www.videogular.com/assets/videos/videogular.webm"), type: "video/webm"},
                    {src: $sce.trustAsResourceUrl("http://www.videogular.com/assets/videos/videogular.ogg"), type: "video/ogg"}
                ],
                transclude: true,
                theme: {
                    url: "styles/themes/default/videogular.css",
                    playIcon: "&#xe000;",
                    pauseIcon: "&#xe001;",
                    volumeLevel3Icon: "&#xe002;",
                    volumeLevel2Icon: "&#xe003;",
                    volumeLevel1Icon: "&#xe004;",
                    volumeLevel0Icon: "&#xe005;",
                    muteIcon: "&#xe006;",
                    enterFullScreenIcon: "&#xe007;",
                    exitFullScreenIcon: "&#xe008;"
                },
                plugins: {
                    poster: {
                        url: "assets/images/videogular.png"
                    },
                    ads: {
                        companion: "companionAd",
                        companionSize: [728, 90],
                        network: "6062",
                        unitPath: "iab_vast_samples",
                        adTagUrl: "http://pubads.g.doubleclick.net/gampad/ads?sz=400x300&iu=%2F6062%2Fiab_vast_samples&ciu_szs=300x250%2C728x90&gdfp_req=1&env=vp&output=xml_vast2&unviewed_position_start=1&url=[referrer_url]&correlator=[timestamp]&cust_params=iab_vast_samples%3Dlinear"
                    }
                }
            };

            $scope.changeSource = function() {
                $scope.config.sources = [
                    {src: $sce.trustAsResourceUrl("http://vjs.zencdn.net/v/oceans.mp4"), type: "video/mp4"},
                    {src: $sce.trustAsResourceUrl("http://vjs.zencdn.net/v/oceans.webm"), type: "video/webm"}
                ];
            };
            /* */
        }]);

    </script>

  </head>
<body>
    <div ng-view ng-cloak></div>
</body>
</html>